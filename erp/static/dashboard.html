<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ERP Portal</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div id="header"></div>
  <main>
    <!-- Add Query Button -->
    <div id="addQueryContainer" class="card">
      <button id="showFormBtn" class="btn btn-primary">+ Add New Query</button>
    </div>

    <!-- Query Form -->
    <div class="card" id="queryCard" style="display: none;">
      <h2 id="formTitle">New Client Query</h2>
      <form id="queryForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="date">Date*</label>
            <input type="date" id="date" required />
          </div>

          <div class="form-group">
            <label for="clientName">Client Name*</label>
            <input type="text" id="clientName" required placeholder="Enter client name" />
          </div>

          <div class="form-group">
            <label for="clientType">Client Type*</label>
            <input type="text" id="clientType" required placeholder="Enter client type" />
          </div>

          <div class="form-group">
            <label for="location">Location*</label>
            <input type="text" id="location" required placeholder="Enter location" />
          </div>

          <div class="form-group">
            <label for="areaSqft">Area (sqft)*</label>
            <input type="number" id="areaSqft" step="0.01" required placeholder="Enter area in square feet" />
          </div>

          <div class="form-group full-width">
            <label for="specification">Specification</label>
            <textarea id="specification" rows="4" placeholder="Enter specifications"></textarea>
          </div>

          <div class="form-group">
            <label for="proposedAmount">Proposed Amount*</label>
            <input type="number" id="proposedAmount" step="0.01" required placeholder="Enter proposed amount" />
          </div>

          <div class="form-group">
            <label for="finalAmount">Final Amount</label>
            <input type="number" id="finalAmount" step="0.01" placeholder="Enter final amount" />
          </div>

          <div class="form-group">
            <label for="status">Status*</label>
            <select id="status" required class="form-select">
              <option value="Ongoing">Ongoing</option>
              <option value="Approved">Approved</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
        </div>

        <div class="action-buttons">
          <button type="submit" id="submitBtn" class="btn btn-primary">Save Query</button>
          <button type="button" id="cancelFormBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Saved Queries Table -->
    <div class="card">
      <h2>Saved Queries</h2>
      <table id="queriesTable" class="queries-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Client</th>
            <th>Type</th>
            <th>Location</th>
            <th>Area</th>
            <th>Proposed</th>
            <th>Final</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="emptyMsg" style="display: none;">No queries found.</p>
    </div>
  </main>

  <script src="header.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (!protectRoute()) return;

      const showBtn = document.getElementById('showFormBtn');
      const cancelBtn = document.getElementById('cancelFormBtn');
      const formCard = document.getElementById('queryCard');
      const addContainer = document.getElementById('addQueryContainer');
      const formTitle = document.getElementById('formTitle');
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('queryForm');
      const emptyMsg = document.getElementById('emptyMsg');
      let editingId = null;

      // Form handlers
      showBtn.addEventListener('click', () => openForm());
      cancelBtn.addEventListener('click', () => resetForm());

      // Form submission handler with validation
      form.addEventListener('submit', async e => {
        e.preventDefault();

        try {
          const payload = {
            clientName: document.getElementById('clientName').value.trim(),
            clientType: document.getElementById('clientType').value.trim(),
            location: document.getElementById('location').value.trim(),
            areaSqft: parseFloat(document.getElementById('areaSqft').value),
            specification: document.getElementById('specification').value.trim(),
            proposedAmount: parseFloat(document.getElementById('proposedAmount').value),
            finalAmount: document.getElementById('finalAmount').value ? parseFloat(document.getElementById('finalAmount').value) : null,
            status: document.getElementById('status').value
          };

          // Basic validation
          if (!payload.clientName || !payload.clientType || !payload.location) {
            throw new Error('Please fill in all required fields');
          }

          if (isNaN(payload.areaSqft) || payload.areaSqft <= 0) {
            throw new Error('Please enter a valid area');
          }

          if (isNaN(payload.proposedAmount) || payload.proposedAmount <= 0) {
            throw new Error('Please enter a valid proposed amount');
          }

          const url = editingId ? `/api/queries/${editingId}` : '/api/queries';
          const method = editingId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save query');
          }

          resetForm();
          loadQueries();
        } catch (error) {
          alert(error.message);
        }
      });

      // Load queries with error handling
      async function loadQueries() {
        try {
          const res = await fetch('/api/queries', {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
          });

          if (!res.ok) {
            throw new Error('Failed to load queries');
          }

          const queries = await res.json();
          const tbody = document.querySelector('#queriesTable tbody');
          tbody.innerHTML = '';

          if (queries.length === 0) {
            emptyMsg.style.display = 'block';
            return;
          }

          emptyMsg.style.display = 'none';

          queries.forEach(q => {
            const row = document.createElement('tr');
            const status = q.status || 'Ongoing';

            row.innerHTML = `
              <td>${q.id}</td>
              <td>${new Date(q.created_at).toLocaleDateString()}</td>
              <td>${q.client_name}</td>
              <td>${q.client_type}</td>
              <td>${q.location}</td>
              <td>${q.area_sqft}</td>
              <td>${q.proposed_amount}</td>
              <td>${q.final_amount || ''}</td>
              <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
              <td class="action-buttons">
                <button onclick="editFull(${q.id})" class="btn btn-secondary">Edit</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          alert('Failed to load queries: ' + error.message);
        }
      }

      // Edit query handler with error handling
      window.editFull = async function(id) {
        try {
          const res = await fetch(`/api/queries/${id}`, {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
          });

          if (!res.ok) {
            throw new Error('Failed to load query details');
          }

          const q = await res.json();

          editingId = id;
          formTitle.textContent = 'Edit Client Query';
          submitBtn.textContent = 'Update Query';

          document.getElementById('date').value = new Date(q.created_at).toISOString().slice(0,10);
          document.getElementById('clientName').value = q.client_name;
          document.getElementById('clientType').value = q.client_type;
          document.getElementById('location').value = q.location;
          document.getElementById('areaSqft').value = q.area_sqft;
          document.getElementById('specification').value = q.specification;
          document.getElementById('proposedAmount').value = q.proposed_amount;
          document.getElementById('finalAmount').value = q.final_amount || '';
          document.getElementById('status').value = q.status || 'Ongoing';

          formCard.style.display = 'block';
          addContainer.style.display = 'none';
        } catch (error) {
          alert('Failed to load query: ' + error.message);
        }
      };

      function openForm() {
        editingId = null;
        formTitle.textContent = 'New Client Query';
        submitBtn.textContent = 'Save Query';
        document.getElementById('date').value = new Date().toISOString().slice(0,10);
        document.getElementById('status').value = 'Ongoing';
        form.reset();
        formCard.style.display = 'block';
        addContainer.style.display = 'none';
      }

      function resetForm() {
        editingId = null;
        form.reset();
        formCard.style.display = 'none';
        addContainer.style.display = 'block';
      }

      // Initial load
      loadQueries();
    });
  </script>
</body>
</html>